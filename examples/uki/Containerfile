# A special form of Containerfile for composefs-enabled UKI images
# This file must have:
#
#  - a stage called 'base' which contains all of the
#    files of the final image, but not the kernel
#
#  - further stages, ultimately resulting in the final container image.  In
#    this image, the kernel must be present in /boot and otherwise no other
#    changes may be made vs. the base image.  This is best-accomplished with a
#    multi-stage build.
#
#  - during the build stages following 'base', the `COMPOSEFS_FSVERITY` build
#    arg will be set to the fsverity digest of the container image.  This should
#    be baked into the UKI.

FROM fedora:42 AS base
RUN --mount=type=cache,target=/var/cache/libdnf5 <<EOF
    set -eux

    mkdir -p /etc/dracut.conf.d
    echo export DRACUT_NO_XATTR=1 > /etc/dracut.conf.d/no-xattr.conf

    dnf -y install fedora-repos-archive
    dnf --setopt keepcache=1 install --allowerasing -y \
        btrfs-progs \
        composefs \
        dosfstools \
        kernel \
        openssh-server \
        policycoreutils-python-utils \
        selinux-policy-targeted \
        skopeo \
        strace \
        systemd \
        systemd-boot-unsigned \
        systemd-ukify \
        util-linux
EOF

# --- Everything above this line should hopefully stay cached ---

COPY cfsctl /usr/bin
COPY extra /
COPY test-thing.fedora-42 /
RUN <<EOF
    set -eux

    systemctl enable systemd-networkd

    # Update selinux-policy-targeted to latest version
    dnf update -y selinux-policy-targeted selinux-policy || true
    dnf install -y setools-console || true

    # Check if sshd_session_t exists and create appropriate policy
    if seinfo -t 2>/dev/null | grep -q sshd_session_t; then
        echo "sshd_session_t type found in policy"
        # Use policy with sshd_session_t
        cat > /etc/composefs_vsock.te <<'POLICY'
module composefs_vsock 1.0;

require {
    type sshd_t;
    type sshd_session_t;
    class vsock_socket { accept bind connect create getattr getopt listen read setopt shutdown write };
}

# Allow sshd-session full vsock_socket permissions
allow sshd_session_t sshd_t:vsock_socket { accept bind connect create getattr getopt listen read setopt shutdown write };
POLICY
        checkmodule -M -m -o /etc/composefs_vsock.mod /etc/composefs_vsock.te
        semodule_package -o /etc/composefs_vsock.pp -m /etc/composefs_vsock.mod
        semodule -i /etc/composefs_vsock.pp
    else
        echo "sshd_session_t type NOT found, skipping vsock policy"
    fi

    checkmodule -M -m -o /etc/composefs_workarounds.mod /etc/composefs_workarounds.te
    semodule_package -o /etc/composefs_workarounds.pp -m /etc/composefs_workarounds.mod
    semodule -i /etc/composefs_workarounds.pp

    passwd -d root
    mkdir /sysroot
EOF

FROM base AS kernel
ARG COMPOSEFS_FSVERITY
RUN --mount=type=cache,target=/var/cache/libdnf5 <<EOF
    set -eux

    mkdir -p /etc/kernel /etc/dracut.conf.d
    echo "composefs=${COMPOSEFS_FSVERITY} rw console=ttyS0,115200n8" > /etc/kernel/cmdline

    kernel-install add-all
EOF

FROM base AS bootable
COPY --from=kernel /boot /boot
